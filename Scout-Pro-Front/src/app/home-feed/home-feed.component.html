<div class="app-container">
  <aside class="left-sidebar" [class.expanded]="sidebarExpanded" (mouseenter)="expandSidebar()" (mouseleave)="collapseSidebar()">
    <div class="logo">{{ sidebarExpanded ? 'Scout Pro' : 'SP' }}</div>
    <nav class="nav-links">
      <a routerLink="/home" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">
        <i class="bi bi-house-fill"></i>
        <span>Home</span>
      </a>
      <a href="#" class="search-link" [class.active]="showSearchPanel" (click)="toggleSearchPanel(); $event.preventDefault()">
        <i class="bi bi-search"></i>
        <span>Search</span>
      </a>
      <a href="#">
        <i class="bi bi-bell"></i>
        <span>Notifications</span>
      </a>
      <a href="#" *ngIf="isPlayer" (click)="openUploadModal(); $event.preventDefault()">
        <i class="bi bi-plus-square"></i>
        <span>Upload</span>
      </a>
      <a href="#" *ngIf="isScout" (click)="toggleFeedFilter(); $event.preventDefault()" [class.active]="showFeedFilter">
        <i class="bi bi-funnel"></i>
        <span>Filter Feed</span>
      </a>
      <div class="profile-menu-container">
        <a href="#" (click)="toggleAccountMenu($event)" class="profile-link" [class.active]="showAccountMenu">
          <img [src]="currentUser?.profile_image || getAvatarUrl(currentUser?.name?.split(' ')[0], currentUser?.name?.split(' ')[1])"
               [alt]="currentUser?.name"
               class="avatar-xs"
               (error)="handleImageError($event, currentUser?.name?.split(' ')[0], currentUser?.name?.split(' ')[1])" />
          <span>{{ currentUser?.name || 'Profile' }}</span>
        </a>
        <div class="account-menu" [class.show]="showAccountMenu">
          <div class="menu-item" (click)="goToProfile()">
            <i class="bi bi-person"></i>
            <span>View Profile</span>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-item" (click)="logout()">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </div>
        </div>
      </div>
    </nav>
  </aside>

  <!-- Search Panel -->
  <div class="search-panel" [class.active]="showSearchPanel">
    <div class="search-header">
      <h2>Search</h2>
      <button class="close-btn" (click)="toggleSearchPanel()">&times;</button>
    </div>

    <div class="search-form">
      <div class="search-input-container">
        <i class="bi bi-search"></i>
        <input
          type="text"
          placeholder="Search players by name or position..."
          class="search-input"
          [(ngModel)]="searchQuery"
          (keyup)="onSearchInput($event)"
          (keyup.enter)="onSearch()"
        />
        <button *ngIf="searchQuery" class="clear-search" (click)="clearSearch()">
          <i class="bi bi-x"></i>
        </button>

        <!-- Position Suggestions Dropdown -->
        <div class="position-suggestions" *ngIf="showPositionSuggestions && filteredPositions.length > 0">
          <div
            *ngFor="let position of filteredPositions; let i = index"
            class="position-suggestion-item"
            [class.active]="i === selectedSuggestionIndex"
            (click)="selectPosition(position)"
            (mouseenter)="selectedSuggestionIndex = i">
            <i class="bi bi-tag"></i>
            {{ position }}
          </div>
        </div>
      </div>

      <!-- Recent Searches -->
      <div class="recent-searches">
        <h4>Recent Searches</h4>
        <div class="recent-search-items">
          <div *ngIf="recentSearches && recentSearches.length > 0">
            <button
              *ngFor="let search of recentSearches"
              class="recent-search-item">
              <div class="search-text" (click)="searchForTerm(search)">
                <i class="bi bi-clock-history"></i>
                {{ search }}
              </div>
              <i class="bi bi-x-circle delete-search" (click)="$event.stopPropagation(); deleteRecentSearch(search)"></i>
            </button>
          </div>
          <div *ngIf="!recentSearches || recentSearches.length === 0" class="no-searches">
            No recent searches
          </div>
        </div>
      </div>

      <!-- Scout Filters -->
      <div class="filter-toggle" (click)="toggleFilter()" *ngIf="isScout">
        <span><i class="fas fa-filter"></i> Filters</span>
        <span class="toggle-indicator" [class.active]="showFilters">▼</span>
      </div>

      <div class="advanced-filters" [class.active]="showFilters && isScout">
        <div class="filter-container">
          <!-- Age Range Filter -->
          <div class="filter-group">
            <label>Age Range</label>
            <select [(ngModel)]="filters.age_range" (change)="onFilterChange('age_range', filters.age_range)">
              <option value="">All Ages</option>
              <option *ngFor="let range of feedData?.filter_options?.age_ranges" [value]="range.value">
                {{ range.label }}
              </option>
            </select>
          </div>

          <!-- Preferred Foot Filter -->
          <div class="filter-group">
            <label>Preferred Foot</label>
            <select [(ngModel)]="filters.preferred_foot" (change)="onFilterChange('preferred_foot', filters.preferred_foot)">
              <option value="">Any</option>
              <option *ngFor="let foot of feedData?.filter_options?.preferred_foot" [value]="foot.value">
                {{ foot.label }}
              </option>
            </select>
          </div>

          <!-- Region Filter -->
          <div class="filter-group">
            <label>Region</label>
            <select [(ngModel)]="filters.region" (change)="onFilterChange('region', filters.region)">
              <option value="">All Regions</option>
              <option *ngFor="let region of feedData?.filter_options?.regions" [value]="region.value">
                {{ region.label }}
              </option>
            </select>
          </div>

          <!-- Transfer Status Filter -->
          <div class="filter-group">
            <label>Transfer Status</label>
            <select [(ngModel)]="filters.transfer_status" (change)="onFilterChange('transfer_status', filters.transfer_status)">
              <option value="">Any Status</option>
              <option *ngFor="let status of feedData?.filter_options?.transfer_status" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
          </div>
        </div>

        <!-- Suggested Roles -->
        <div class="suggested-roles" *ngIf="feedData?.filter_options?.suggested_roles?.length">
          <h4>Suggested Roles</h4>
          <div class="role-tags">
            <span *ngFor="let role of feedData?.filter_options?.suggested_roles"
                  class="role-tag"
                  (click)="searchForTerm(role)">
              {{ role }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-spinner" *ngIf="loading">
      <i class="fas fa-spinner fa-spin"></i>
    </div>

    <!-- Search Results -->
    <div class="search-results" *ngIf="searchResults.length > 0">
      <div *ngFor="let result of searchResults" class="player-card" [ngClass]="{'scout-card': result.type === 'scout'}">
        <img [src]="result.profile_image || getAvatarUrl(result.first_name, result.last_name)"
             [alt]="result.full_name"
             class="player-avatar"
             (error)="handleImageError($event, result.first_name, result.last_name)">
        <div class="player-info">
          <h3>{{ result.full_name }}</h3>
          <div class="type-badge" [ngClass]="result.type">{{ result.type | titlecase }}</div>

          <!-- Player-specific info -->
          <ng-container *ngIf="result.type === 'player'">
            <div class="position">{{ result.position }}</div>
            <div class="meta">{{ result.nationality }} • {{ result.current_city }}</div>
          </ng-container>

          <!-- Scout-specific info -->
          <ng-container *ngIf="result.type === 'scout'">
            <div class="position">{{ result.position_title }}</div>
            <div class="organization">{{ result.organization }}</div>
            <div class="meta">{{ result.city }}, {{ result.country }}</div>
          </ng-container>
        </div>
        <button class="view-profile-btn" (click)="result.type === 'player' ? goToPlayerProfile(result.id) : goToScoutProfile(result.id)">
          View Profile
        </button>
      </div>
    </div>

    <!-- No Results State -->
    <div class="no-results" *ngIf="searchQuery && searchResults.length === 0 && !loading">
      <i class="fas fa-search"></i>
      <p>No players or scouts found matching your search criteria</p>
    </div>
  </div>

  <!-- Main Feed Content -->
  <div class="feed-container">
    <!-- Loading and Error States -->
    <div *ngIf="loading" class="loading"><span class="spinner"></span> Loading feed...</div>
    <div *ngIf="error" class="error" aria-live="assertive">{{ error }}</div>
    <div *ngIf="notification" class="notification" aria-live="polite">{{ notification }}</div>

    <!-- Feed Filter Panel for Scouts -->
    <div class="feed-filter-panel" *ngIf="isScout && showFeedFilter">
      <div class="filter-header">
        <h3>Filter Feed</h3>
        <button class="close-btn" (click)="toggleFeedFilter()">&times;</button>
      </div>
      <div class="filter-container">
        <!-- Age Range Filter -->
        <div class="filter-group">
          <label>Age Range</label>
          <select [(ngModel)]="feedFilters.age_range"
                  (focus)="onSelectFocus('age')"
                  (keydown)="onSelectKeydown($event, 'age')">
            <option value="">All Ages</option>
            <option *ngFor="let range of filteredLists.ageRanges" [value]="range.value">
              {{ range.label }}
            </option>
          </select>
        </div>

        <!-- Preferred Foot Filter -->
        <div class="filter-group">
          <label>Preferred Foot</label>
          <select [(ngModel)]="feedFilters.preferred_foot"
                  (focus)="onSelectFocus('foot')"
                  (keydown)="onSelectKeydown($event, 'foot')">
            <option value="">Any</option>
            <option *ngFor="let foot of filteredLists.preferredFoot" [value]="foot.value">
              {{ foot.label }}
            </option>
          </select>
        </div>

        <!-- Region Filter -->
        <div class="filter-group">
          <label>Region</label>
          <select [(ngModel)]="feedFilters.region"
                  (focus)="onSelectFocus('region')"
                  (keydown)="onSelectKeydown($event, 'region')">
            <option value="">All Regions</option>
            <option *ngFor="let region of filteredLists.regions" [value]="region">
              {{ region }}
            </option>
          </select>
        </div>

        <!-- Position Filter -->
        <div class="filter-group">
          <label>Position</label>
          <select [(ngModel)]="feedFilters.position"
                  (focus)="onSelectFocus('position')"
                  (keydown)="onSelectKeydown($event, 'position')">
            <option value="">All Positions</option>
            <option *ngFor="let position of filteredLists.positions" [value]="position">
              {{ position }}
            </option>
          </select>
        </div>

        <!-- Transfer Status Filter -->
        <div class="filter-group">
          <label>Transfer Status</label>
          <select [(ngModel)]="feedFilters.transfer_status"
                  (focus)="onSelectFocus('status')"
                  (keydown)="onSelectKeydown($event, 'status')">
            <option value="">Any Status</option>
            <option *ngFor="let status of filteredLists.transferStatus" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <!-- Filter Actions -->
        <div class="filter-actions">
          <button class="apply-filters-btn" (click)="applyFeedFilters()">Apply Filters</button>
          <button class="clear-filters-btn" (click)="clearFeedFilters()">Clear Filters</button>
        </div>
      </div>
    </div>

    <!-- View Switcher -->
    <div *ngIf="feedData && !loading" class="view-switcher">
      <button [class.active]="activeView === 'feed'" (click)="switchView('feed')">
        <i class="bi bi-play-btn"></i> Feed
      </button>
      <button [class.active]="activeView === 'events'" (click)="switchView('events')">
        <i class="bi bi-calendar-event"></i> Events
      </button>
    </div>

    <!-- Feed Content -->
    <ng-container *ngIf="feedData">
      <!-- Feed View (Default) -->
      <div *ngIf="activeView === 'feed'" class="reels-container">
        <div *ngIf="!feedData?.posts?.data?.length" class="empty-feed">
          No videos to show. Try adjusting your filters or check back later!
        </div>

        <div *ngFor="let post of feedData?.posts?.data" class="reel-card">
          <div class="reel-header">
            <div class="reel-user" (click)="post?.user?.isCurrentUser ? goToProfile() : goToPlayerProfile(post?.user?.player_id)">
              <img [src]="getProfileImageUrl(post?.user?.profile_image)"
                   class="avatar-sm"
                   [alt]="post?.user?.full_name"
                   (error)="handleImageError($event, post?.user?.first_name, post?.user?.last_name)">
              <div class="reel-user-info">
                <span class="username">{{ post?.user?.isCurrentUser ? 'You' : post?.user?.full_name }}</span>
                <span class="user-meta" *ngIf="post?.user?.player">{{ post?.user?.player?.position || 'No Position' }} • {{ post?.user?.player?.region || post?.user?.player?.nationality || 'No Region' }}</span>
              </div>
            </div>
            <button
              class="follow-btn"
              *ngIf="!post?.user?.isCurrentUser &&
                     post?.user?.user_type === 'player' &&
                     !post?.user?.following"
              (click)="followPlayer(post?.user?.player_id)"
            >Follow</button>
            <span class="following-label"
                  *ngIf="!post?.user?.isCurrentUser &&
                         post?.user?.user_type === 'player' &&
                         post?.user?.following">
              <i class="bi bi-check2"></i> Following
            </span>
          </div>

          <div class="reel-video">
            <video controls
                   [poster]="post?.thumbnail || ''"
                   preload="metadata"
                   (play)="onVideoPlay($event, post?.id)"
                   (error)="onVideoError($event)">
              <source [src]="getVideoUrl(post?.file_path)" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>

          <div class="reel-actions">
            <button (click)="likePost(post?.id)" class="action-btn like-btn" [ngClass]="{'active': post?.has_liked}">
              <i class="bi" [ngClass]="{'bi-heart-fill': post?.has_liked, 'bi-heart': !post?.has_liked}"></i>
              <span class="action-count" (click)="showLikesList(post?.id, $event)">{{ post?.likes_count || 0 }}</span>
            </button>
            <button (click)="toggleCommentBox(post?.id)" class="action-btn">
              <i class="bi bi-chat"></i>
              <span class="action-count">{{ post?.comments_count || 0 }}</span>
            </button>
            <button class="action-btn" (click)="post?.user?.isCurrentUser ? goToProfile() : goToPlayerProfile(post?.user?.player_id)">
              <i class="bi bi-person"></i>
            </button>
            <div class="views-count">
              <i class="bi bi-eye"></i> {{ post?.views || 0 }}
            </div>
          </div>

          <div class="reel-caption">
            <p>
              <span>
                <span class="username" (click)="post?.user?.isCurrentUser ? goToProfile() : goToPlayerProfile(post?.user?.player_id)">
                  {{ post?.user?.isCurrentUser ? 'You' : post?.user?.full_name }}
                </span>
                {{ post?.description }}
              </span>
            <span class="post-date">{{ post?.created_at | date }}</span>
            </p>
          </div>

          <!-- Comments Section -->
          <div class="reel-comments" *ngIf="post?.comments?.length > 0">
            <div *ngFor="let comment of post?.comments?.slice(0, 2)" class="comment">
              <span class="comment-user" (click)="comment?.user?.isCurrentUser ? goToProfile() : goToUserProfile(comment?.user?.player_id)">
                {{ comment?.user?.isCurrentUser ? 'You' : comment.user?.full_name }}
              </span>
              <span class="comment-text">{{ comment.content }}</span>
              <span class="comment-time">{{ comment.created_at | date:'short' }}</span>
            </div>
            <div *ngIf="post?.comments?.length > 2" class="view-more-comments" (click)="toggleCommentBox(post?.id)">
              View all {{ post?.comments?.length }} comments
            </div>
          </div>

          <!-- Comment Box -->
          <div class="comment-box" *ngIf="showCommentBox[post?.id]">
            <!-- <div class="all-comments">
              <div *ngFor="let comment of post?.comments" class="comment">
                <span class="comment-user">{{ comment.user_id === currentUser?.id ? 'You' : comment.user?.full_name }}</span>
                <span class="comment-text">{{ comment.content }}</span>
                <span class="comment-time">{{ comment.created_at | date:'short' }}</span>
              </div>
            </div> -->
            <div class="add-comment">
              <input
                type="text"
                placeholder="Add a comment..."
                [(ngModel)]="newComment"
                (keyup.enter)="postComment(post?.id)"
              >
              <button class="post-comment-btn" (click)="postComment(post?.id)">Post</button>
            </div>
          </div>
        </div>

        <div *ngIf="feedData.posts.data.length > 0 && feedData.posts.current_page < feedData.posts.last_page" class="load-more">
          <button class="btn btn-outline" (click)="loadMore()" [disabled]="loading">
            <span *ngIf="!loading">Load More</span>
            <span *ngIf="loading" class="spinner small"></span>
          </button>
        </div>
      </div>

      <!-- Events View -->
      <div *ngIf="activeView === 'events'" class="events-container">
        <div *ngIf="!feedData.upcoming_events?.length" class="empty-feed">
          No upcoming events. Check back later for new opportunities!
        </div>

        <div class="events-grid">
          <div *ngFor="let event of feedData.upcoming_events" class="event-card" (click)="goToEvent(event.id)">
            <div class="event-image">
              <img [src]="event.image || 'assets/default-event.jpg'" alt="{{ event.title }}">
              <div class="event-date-badge">
                {{ event.date | date:'MMM dd' }}
              </div>
            </div>
            <div class="event-details">
              <h3>{{ event.title }}</h3>
              <p class="event-location"><i class="bi bi-geo-alt"></i> {{ event.location }}</p>
              <p class="event-description">{{ event.desc }}</p>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Right Panel -->
  <aside class="right-panel">
    <div class="profile-info">
      <a href="#" (click)="goToProfile(); $event.preventDefault()" class="profile-link">
        <img [src]="currentUser?.profile_image || getAvatarUrl(currentUser?.name?.split(' ')[0], currentUser?.name?.split(' ')[1])"
             [alt]="currentUser?.name"
             class="avatar"
             (error)="handleImageError($event, currentUser?.name?.split(' ')[0], currentUser?.name?.split(' ')[1])" />
        <div class="profile-name">{{ currentUser?.name || 'Profile' }}</div>
      </a>
    </div>

    <div class="trending">
      <h4>Trending Players</h4>
      <div class="trending-list">
        <div *ngFor="let player of feedData?.trending_players"
             class="trending-item"
             (click)="player?.id === currentUser?.player_id ? goToProfile() : goToPlayerProfile(player?.id)">
          <img [src]="getProfileImageUrl(player?.profile_image)"
               class="avatar-sm"
               [alt]="player?.name"
               (error)="handleImageError($event, player?.name?.split(' ')[0], player?.name?.split(' ')[1])">
          <div class="trending-info">
            <span class="trending-name">{{ player?.id === currentUser?.player_id ? 'You' : player?.name }}</span>
            <span class="trending-meta">{{ player?.position || 'No Position' }} • {{ player?.region || 'No Region' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="events">
      <div class="section-header">
      <h4>Upcoming Events</h4>
        <a href="#" (click)="switchView('events'); $event.preventDefault()" class="see-all">See all</a>
      </div>

      <div class="event-card" *ngFor="let event of feedData?.upcoming_events" (click)="goToEvent(event.id)">
        <div class="event-bg" [style.background-image]="'url(' + (event.image || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80') + ')'">
          <div class="event-overlay">
            <div class="event-title">{{ event.title }}</div>
            <div class="event-date">{{ event.date | date }}</div>
            <div class="event-location"><i class="bi bi-geo-alt"></i> {{ event.location }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="recommendations">
      <h4>You May Also Like</h4>
      <div class="recommendation-list">
        <div *ngFor="let rec of feedData?.recommendations" class="recommendation-item" (click)="goToPlayerProfile(rec?.id)">
          <img [src]="rec?.image || getAvatarUrl(rec?.name?.split(' ')[0], rec?.name?.split(' ')[1])"
               class="avatar-sm"
               [alt]="rec?.name"
               (error)="handleImageError($event, rec?.name?.split(' ')[0], rec?.name?.split(' ')[1])">
          <div class="recommendation-info">
            <span class="recommendation-name">{{ rec?.name || 'Unknown Player' }}</span>
            <span class="recommendation-meta">{{ rec?.position || 'No Position' }} • {{ rec?.region || 'No Region' }}</span>
          </div>
          <button class="btn btn-sm">View</button>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Video Upload Modal -->
<div class="modal" [class.show]="uploadModalOpen">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Upload New Video</h2>
      <span class="close" (click)="closeUploadModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="title">Title:</label>
        <input type="text" id="title" [(ngModel)]="uploadData.title" class="form-control" placeholder="Video title">
      </div>
      <div class="form-group">
        <label for="description">Description:</label>
        <textarea id="description" [(ngModel)]="uploadData.description" class="form-control" rows="3" placeholder="Video description"></textarea>
      </div>
      <div class="form-group">
        <label for="video">Video File:</label>
        <input type="file" id="video" (change)="onFileSelected($event)" class="form-control" accept="video/*">
      </div>
      <div *ngIf="uploadProgress > 0" class="upload-progress">
        <div class="progress-bar" [style.width.%]="uploadProgress"></div>
        <span>{{ uploadProgress }}%</span>
      </div>
      <p *ngIf="uploadError" class="error-message">{{ uploadError }}</p>
      <p *ngIf="userProfile?.subscription_plan === 'Free' && (userProfile?.remaining_uploads ?? 0) > 0" class="upload-limit-info">
        You have {{ userProfile?.remaining_uploads ?? 0 }}/3 uploads remaining this month.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeUploadModal()">Cancel</button>
      <button class="btn btn-primary" (click)="uploadVideo()">Upload</button>
    </div>
  </div>
</div>

<!-- Likes List Modal -->
<div class="modal" [class.show]="showLikesModal">
  <div class="modal-content likes-modal">
    <div class="modal-header">
      <h2>Likes</h2>
      <span class="close" (click)="closeLikesModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="likes-list">
        <div *ngFor="let like of selectedPostLikes" class="like-item">
          <div class="like-user" (click)="like?.user?.id === currentUser?.id ? goToProfile() : goToPlayerProfile(like?.user?.id)">
            <img [src]="like?.user?.profile_image || getAvatarUrl(like?.user?.first_name, like?.user?.last_name)"
                 class="avatar-sm"
                 [alt]="like?.user?.full_name"
                 (error)="handleImageError($event, like?.user?.first_name, like?.user?.last_name)">
            <div class="user-info">
              <div class="user-name">{{ like?.user?.full_name }}</div>
              <div class="user-details" *ngIf="like?.user?.user_type === 'player' && like?.user?.player">
                <span class="position">Player - {{ like?.user?.player?.position }}</span>
              </div>
              <div class="user-details" *ngIf="like?.user?.user_type === 'scout'">
                <span class="role">Scout {{ like?.user?.role }}</span>
              </div>
            </div>
          </div>
          <div class="action-buttons" *ngIf="like?.user?.id !== currentUser?.id">
            <button class="follow-btn"
                    (click)="like?.user?.following ? unfollowPlayer(like?.user?.id) : followPlayer(like?.user?.id)"
                    [class.following]="like?.user?.following">
            {{ like?.user?.following ? 'Following' : 'Follow' }}
          </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
